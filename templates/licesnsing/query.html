{% load widget_tweaks %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}
{% load  static %}
<html lang="ar">

<body dir="rtl">
    <div class="container">
        <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="card">
                <div class="card-header">
                    <h3>بيانات المنشأة المراد معاينتها</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.rifd.label}} {{ eform.rifd|add_class:"form-control"}}
                            </div>
                        </div>


                    </div>
                    <hr class="mt-5">
                    <div class="row">
                        <hr class="mt-5">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.establishment_name.label }} {{ eform.establishment_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.main_category.label }} {{ eform.main_category|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.sub_category.label }} {{ eform.sub_category|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.box_O_P.label }} {{ eform.box_O_P|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.email.label }} {{ eform.email|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.phone_number.label }} {{ eform.phone_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.owner_name.label }} {{ eform.owner_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.owner_number.label }} {{ eform.owner_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.director_name.label }} {{ eform.director_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.director_number.label }} {{ eform.director_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.representative_name.label }} {{ eform.representative_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.representative_number.label }} {{ eform.representative_number|add_class:"form-control"}}
                            </div>
                        </div>
                    </div>
                    <hr class="mt-5">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.municipality_name.label }} {{ eform.municipality_name|add_class:"form-control"}}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.region_number.label }} {{ eform.region_number|add_class:"form-control"}}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.street_number.label}} {{ eform.street_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.street_name.label }} {{ eform.street_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.block_number.label }} {{ eform.block_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.block_name.label }} {{ eform.block_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.building_number.label }} {{ eform.building_number|add_class:"form-control"}}
                            </div>
                        </div>
                    </div>
                    <hr class="mt-5">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.activity_name.label }} {{ eform.activity_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.activity_code.label }} {{ eform.activity_code|add_class:"form-control"}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
            <br>
            <div class="card">
                <div class="card-header">
                    <h3>بيانات المعاينة</h3>
                </div>
                <br><br>
                <form action="/inspect_establishment/{{ establishment.id }}" method="post" enctype="multipart/form-data">
                    <div class="card-body">
                        {% csrf_token %}







                        <div class="row ">
                        <div class="col-md-6">
                            <input type="hidden" name="rifd" value="{{ eform.rifd.value }}">
                        <input type="hidden" name="register_number" value="{{ register_number }}">
                            <script !src="">console.log({{ register_number }})</script>
                        <input type="hidden" name="inspector" value="{{ user.id }}">
                            <div class="form-group">
                                {{ eform.rifd.label}} {{ eform.rifd|add_class:"form-control"}}
                            </div>
                        </div>

                        <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <button id="find-me" style="background-color: #8A1538; color: white" onclick="getLocation()" class="form-control " type="button">أضغط لتحديد المكان</button><br/>
                                <p id="status"></p><br/>
                                <div id="map" class="big-map"></div>
                                {{ iform.latitude|add_class:"form-control"|attr:"id:latitude" }} {{ iform.longitude|add_class:"form-control"|attr:"id:longitude" }}
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="row ">
                        <div class="col-md-6 ">
                            <div class="form-group ">
                                {{ iform.status.label }} {{ iform.status|add_class:"list-unstyled" }}
                            </div>
                        </div>
                        <div class="col-md-6 ">
                            <div id="notes-group" class="form-group ">
                                {{ iform.notes.label }} {{ iform.notes|add_class:"form-control" }}
                            </div>
                        </div>
                    </div>
                       <div class="row ">
                        <div class="col-md-6 ">
                            <input type="file" id="register_photo" name="register_photo" accept="image/*" capture="environment" />
                        </div>
                    </div><div class="row ">
                        <div class="col-md-6 ">
                            <input type="file" id="license_photo" name="license_photo" accept="image/*" capture="environment" />
                        </div>
                    </div><div class="row ">
                        <div class="col-md-6 ">
                            <input type="file" id="establishment_photo" name="establishment_photo" accept="image/*" capture="environment" />
                        </div>
                    </div><div class="row ">
                        <div class="col-md-6 ">
                            <input type="file" id="cars_building_photo" name="cars_building_photo" accept="image/*" capture="environment" />
                        </div>
                    </div>
                </div>
                <div class="row ">
                    <div class="col-md-12 ">
                        <div class="form-group ">
                            <input type="submit" value="حفظ" style="background-color: #8A1538; color: white"  class="form-control">
                        </div>
                    </div>
                </div>
    </form>
    </div>
    </div>

</body>
<script>
const MAX_WIDTH = 320;
const MAX_HEIGHT = 180;

// Select all image input fields that have the attributes you want.
const inputs = document.querySelectorAll('input[type="file"][accept="image/*"][capture="environment"]');

// Add change event listener to each input.
inputs.forEach(input => {
  input.onchange = function(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Create a blob URL for the selected file.
    const blobURL = URL.createObjectURL(file);
    const img = new Image();
    img.src = blobURL;

    img.onload = function () {
      // Calculate the new dimensions while maintaining aspect ratio.
      const [newWidth, newHeight] = calculateSize(img, MAX_WIDTH, MAX_HEIGHT);
      const canvas = document.createElement("canvas");
      canvas.width = newWidth;
      canvas.height = newHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, newWidth, newHeight);

      // Compress the image and convert it to a blob.
      canvas.toBlob((blob) => {
        // Create a display message showing original and compressed sizes.
        const displayTag = document.createElement('h1');
        displayTag.innerText = `Original Image - ${readableBytes(file.size)} :::::: Compressed Image - ${readableBytes(blob.size)}`;
        document.getElementById('container').append(displayTag);

        // Optionally: you can now upload or process 'blob' as needed.
      }, 'image/jpeg', 0.7); // Adjust image type and quality as needed.
    };
  }
});

function calculateSize(img, maxWidth, maxHeight) {
  let width = img.width;
  let height = img.height;

  // Constrain dimensions while maintaining the aspect ratio.
  if (width > height) {
    if (width > maxWidth) {
      height = Math.round((height * maxWidth) / width);
      width = maxWidth;
    }
  } else {
    if (height > maxHeight) {
      width = Math.round((width * maxHeight) / height);
      height = maxHeight;
    }
  }
  return [width, height];
}

function readableBytes(bytes) {
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
}
</script>
</html>