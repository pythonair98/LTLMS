{% extends 'base.html' %}
{% load crispy_forms_filters widget_tweaks %}
{% load static %}

{% block title %}
    <title>اختر المنشأة</title>
{% endblock %}

{% block content %}
    <div id="container" class="container">
        <form class="form-horizontal" action="" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="card">
                <div class="card-header">
                    <h3>بيانات المنشأة المراد معاينتها</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.rifd.label}} {{ eform.rifd|add_class:"form-control"}}
                            </div>
                        </div>


                    </div>
                    <hr class="mt-5">
                    <div class="row">
                        <hr class="mt-5">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.establishment_name.label }} {{ eform.establishment_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.main_category.label }} {{ eform.main_category|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.sub_category.label }} {{ eform.sub_category|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.box_O_P.label }} {{ eform.box_O_P|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.email.label }} {{ eform.email|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.phone_number.label }} {{ eform.phone_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.owner_name.label }} {{ eform.owner_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.owner_number.label }} {{ eform.owner_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.director_name.label }} {{ eform.director_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.director_number.label }} {{ eform.director_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.representative_name.label }} {{ eform.representative_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.representative_number.label }} {{ eform.representative_number|add_class:"form-control"}}
                            </div>
                        </div>
                    </div>
                    <hr class="mt-5">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.municipality_name.label }} {{ eform.municipality_name|add_class:"form-control"}}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.region_number.label }} {{ eform.region_number|add_class:"form-control"}}
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.street_number.label}} {{ eform.street_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.street_name.label }} {{ eform.street_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.block_number.label }} {{ eform.block_number|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.block_name.label }} {{ eform.block_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.building_number.label }} {{ eform.building_number|add_class:"form-control"}}
                            </div>
                        </div>
                    </div>
                    <hr class="mt-5">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.activity_name.label }} {{ eform.activity_name|add_class:"form-control"}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                {{ eform.activity_code.label }} {{ eform.activity_code|add_class:"form-control"}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
            <br>
            <div class="card">
                <div class="card-header">
                    <h3>بيانات المعاينة</h3>
                </div>
                <br><br>
                <form id="inspectForm" action="/inspect_establishment/{{ establishment.id }}" method="post" enctype="multipart/form-data">
                    <div class="card-body">
                        {% csrf_token %}







                        <div class="row ">
                        <div class="col-md-6">
                            <input type="hidden" name="rifd" value="{{ eform.rifd.value }}">
                        <input type="hidden" name="register_number" value="{{ register_number }}">
                            <script !src="">console.log({{ register_number }})</script>
                        <input type="hidden" name="inspector" value="{{ user.id }}">
                            <div class="form-group">
                                {{ eform.rifd.label}} {{ eform.rifd|add_class:"form-control"}}
                            </div>
                        </div>

                        <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <button id="find-me" style="background-color: #8A1538; color: white" onclick="getLocation()" class="form-control " type="button">أضغط لتحديد المكان</button><br/>
                                <p id="status"></p><br/>
                                <div id="map" class="big-map"></div>
                                {{ iform.latitude|add_class:"form-control"|attr:"id:latitude" }} {{ iform.longitude|add_class:"form-control"|attr:"id:longitude" }}
                            </div>
                        </div>
                    </div>
                    </div>
                    <div class="row ">
                        <div class="col-md-6 ">
                            <div class="form-group ">
                                {{ iform.status.label }} {{ iform.status|add_class:"list-unstyled" }}
                            </div>
                        </div>
                        <div class="col-md-6 ">
                            <div id="notes-group" class="form-group ">
                                {{ iform.notes.label }} {{ iform.notes|add_class:"form-control" }}
                            </div>
                        </div>
                    </div>
                       <div class="row ">
                        <div class="col-md-6 ">
                            <input type="file" id="register_photo" name="register_photo" accept="image/*" capture="environment" />
                        </div>
                    </div><div class="row ">
                        <div class="col-md-6 ">
                            <input type="file" id="license_photo" name="license_photo" accept="image/*" capture="environment" />
                        </div>
                    </div><div class="row ">
                        <div class="col-md-6 ">
                            <input type="file" id="establishment_photo" name="establishment_photo" accept="image/*" capture="environment" />
                        </div>
                    </div><div class="row ">
                        <div class="col-md-6 ">
                            <input type="file" id="cars_building_photo" name="cars_building_photo" accept="image/*" capture="environment" />
                        </div>
                    </div>
                </div>
                <div class="row ">
                    <div class="col-md-12 ">
                        <div class="form-group ">
                            <input type="submit" value="حفظ" style="background-color: #8A1538; color: white"  class="form-control">
                        </div>
                    </div>
                </div>
    </form>
    </div>
    </div>
<!DOCTYPE html>

  <script>
    document.getElementById('inspectForm').addEventListener('submit', async function (event) {
        event.preventDefault(); // Prevent form submission

        const form = event.target;
        const formData = new FormData(form);

        // List of image fields to compress
        const imageFields = ['register_photo', 'license_photo', 'establishment_photo', 'cars_building_photo'];

        for (const fieldName of imageFields) {
            const fileInput = document.getElementById(fieldName);
            const file = fileInput.files[0];
            if (file) {
                const compressedBlob = await compressImageQualityOnly(file);
                formData.set(fieldName, compressedBlob, file.name); // Replace original file with compressed blob
            }
        }

        // Submit the form with compressed images
        fetch(form.action, {
            method: form.method,
            body: formData,
        })
            .then((response) => {
                if (response.ok) {
                } else {
                    window.location = response.url;
                }
            })
            .catch((error) => {
                console.error('Submission error:', error);
                alert('An error occurred during submission.');
            });
    });

    // Function to compress image quality without changing resolution
    function compressImageQualityOnly(file) {
        return new Promise((resolve) => {
            const blobURL = URL.createObjectURL(file);
            const img = new Image();
            img.src = blobURL;

            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width; // Keep original width
                canvas.height = img.height; // Keep original height

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, img.width, img.height);

                // Compress the image by adjusting the quality (0.7 means 70% quality)
                canvas.toBlob(
                    (blob) => {
                        resolve(blob); // Return the compressed image blob
                    },
                    'image/jpeg',
                    0.5 // Adjust the compression quality here (e.g., 0.5 = 50% quality)
                );
            };
        });
    }
</script>
{% endblock %}

